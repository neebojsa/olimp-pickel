<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API Key Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #4285f4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background: #357ae8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #result {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
        }
        .success {
            color: #0f9d58;
            font-weight: bold;
        }
        .error {
            color: #ea4335;
            font-weight: bold;
        }
        .info {
            color: #4285f4;
        }
        .loading {
            color: #fbbc04;
        }
        .note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Gemini API Key Test</h1>
        
        <div class="note">
            <strong>Note:</strong> This test will check which Gemini models are available with your API key.
            Your API key will be sent to Google's servers for testing.
        </div>

        <div>
            <label for="apiKey">Enter your Gemini API Key:</label>
            <input 
                type="password" 
                id="apiKey" 
                placeholder="AIzaSy..." 
                value=""
            >
            <small style="color: #666;">Or leave empty to use from .env.local (if running via dev server)</small>
        </div>

        <button onclick="listAvailableModels()" id="listBtn">üìã List Available Models (Do This First!)</button>
        <button onclick="testGemini()" id="testBtn">Test API Key</button>
        <button onclick="testWithFile()" id="testFileBtn" disabled>Test with PDF/Image</button>
        <button onclick="clearResults()">Clear Results</button>

        <div id="result"></div>
    </div>

    <script type="module">
        // Import Google Generative AI from CDN
        const { GoogleGenerativeAI } = await import('https://esm.run/@google/generative-ai');

        window.testGemini = async function() {
            const apiKeyInput = document.getElementById('apiKey');
            const resultDiv = document.getElementById('result');
            const testBtn = document.getElementById('testBtn');
            const testFileBtn = document.getElementById('testFileBtn');
            
            let apiKey = apiKeyInput.value.trim();
            
            // If no API key provided, try to get from environment (if running via dev server)
            if (!apiKey) {
                resultDiv.innerHTML = '<span class="loading">‚è≥ Trying to get API key from environment...</span>';
                // Note: In browser, we can't access .env.local directly
                // User needs to paste it or we need to run this via dev server
                resultDiv.innerHTML += '<br><span class="error">‚ùå Please enter your API key in the input field above.</span>';
                return;
            }

            testBtn.disabled = true;
            resultDiv.innerHTML = '<span class="loading">üîÑ Testing API key...</span><br><br>';

            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                
                // List of models to test - will be populated from ListModels API if available
                // Otherwise try common model names
                let models = [];
                
                // Try to get models from the list first
                if (window.availableModels && window.availableModels.length > 0) {
                    models = window.availableModels;
                    resultDiv.innerHTML += `<span class="info">Using models from API list: ${models.join(', ')}</span><br><br>`;
                } else {
                    // Fallback to common model names
                    models = [
                        'gemini-2.5-pro',  // Suggested in error message
                        'gemini-2.0-pro-exp',
                        'gemini-1.5-pro',
                        'gemini-1.5-flash',
                        'gemini-pro',
                        'gemini-pro-vision'
                    ];
                    resultDiv.innerHTML += `<span class="info">‚ö†Ô∏è Using fallback model list. Click "List Available Models" first for accurate results.</span><br><br>`;
                }
                
                let workingModels = [];
                let failedModels = [];

                resultDiv.innerHTML += '<span class="info">üìã Testing available models...</span><br><br>';

                for (const modelName of models) {
                    try {
                        resultDiv.innerHTML += `<span class="loading">‚è≥ Testing ${modelName}...</span><br>`;
                        resultDiv.scrollTop = resultDiv.scrollHeight;
                        
                        const model = genAI.getGenerativeModel({ model: modelName });
                        const result = await model.generateContent('Say "Hello" in one word');
                        const response = await result.response;
                        const text = response.text();
                        
                        workingModels.push(modelName);
                        resultDiv.innerHTML += `<span class="success">‚úì ${modelName} works! Response: "${text}"</span><br>`;
                        
                    } catch (error) {
                        failedModels.push({ model: modelName, error: error.message });
                        resultDiv.innerHTML += `<span class="error">‚úó ${modelName} failed: ${error.message}</span><br>`;
                    }
                    resultDiv.scrollTop = resultDiv.scrollHeight;
                }

                // Summary
                resultDiv.innerHTML += '<br><hr><br>';
                resultDiv.innerHTML += `<span class="info"><strong>Summary:</strong></span><br>`;
                resultDiv.innerHTML += `<span class="success">‚úì Working models: ${workingModels.length > 0 ? workingModels.join(', ') : 'None'}</span><br>`;
                resultDiv.innerHTML += `<span class="error">‚úó Failed models: ${failedModels.length}</span><br><br>`;

                if (workingModels.length > 0) {
                    resultDiv.innerHTML += `<span class="success"><strong>‚úÖ Your API key is valid!</strong></span><br>`;
                    resultDiv.innerHTML += `<span class="info">Recommended model: ${workingModels[0]}</span><br>`;
                    testFileBtn.disabled = false;
                    window.workingApiKey = apiKey;
                    window.workingModel = workingModels[0];
                } else {
                    resultDiv.innerHTML += `<span class="error"><strong>‚ùå No working models found. Check your API key and permissions.</strong></span><br>`;
                }

            } catch (error) {
                resultDiv.innerHTML += `<span class="error">‚ùå Error: ${error.message}</span><br>`;
                console.error('Full error:', error);
            } finally {
                testBtn.disabled = false;
            }
        };

        window.testWithFile = async function() {
            if (!window.workingApiKey || !window.workingModel) {
                alert('Please test your API key first!');
                return;
            }

            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.jpg,.jpeg,.png';
            
            fileInput.onchange = async (event) => {
                const file = event.target.files?.[0];
                if (!file) return;

                const resultDiv = document.getElementById('result');
                const testFileBtn = document.getElementById('testFileBtn');
                
                testFileBtn.disabled = true;
                resultDiv.innerHTML += '<br><hr><br>';
                resultDiv.innerHTML += `<span class="loading">üîÑ Testing file upload: ${file.name} (${(file.size / 1024).toFixed(1)} KB)...</span><br>`;
                resultDiv.scrollTop = resultDiv.scrollHeight;

                try {
                    const genAI = new GoogleGenerativeAI(window.workingApiKey);
                    const model = genAI.getGenerativeModel({ model: window.workingModel });

                    // Convert file to base64
                    const reader = new FileReader();
                    reader.onload = async () => {
                        const base64Data = reader.result.split(',')[1];
                        const mimeType = file.type;

                        try {
                            const prompt = 'Extract the main text from this document. Return only the text content, no JSON.';
                            
                            const result = await model.generateContent([
                                {
                                    inlineData: {
                                        data: base64Data,
                                        mimeType: mimeType
                                    }
                                },
                                { text: prompt }
                            ]);

                            const response = await result.response;
                            const text = response.text();

                            resultDiv.innerHTML += `<span class="success">‚úÖ File processed successfully!</span><br>`;
                            resultDiv.innerHTML += `<span class="info">Extracted text (first 500 chars):</span><br>`;
                            resultDiv.innerHTML += `<div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px;">${text.substring(0, 500)}...</div>`;
                            resultDiv.innerHTML += `<span class="success">Total length: ${text.length} characters</span><br>`;

                        } catch (error) {
                            resultDiv.innerHTML += `<span class="error">‚ùå Error processing file: ${error.message}</span><br>`;
                            console.error('File processing error:', error);
                        } finally {
                            testFileBtn.disabled = false;
                        }
                    };

                    reader.onerror = () => {
                        resultDiv.innerHTML += `<span class="error">‚ùå Error reading file</span><br>`;
                        testFileBtn.disabled = false;
                    };

                    reader.readAsDataURL(file);
                } catch (error) {
                    resultDiv.innerHTML += `<span class="error">‚ùå Error: ${error.message}</span><br>`;
                    testFileBtn.disabled = false;
                }
            };

            fileInput.click();
        };

        window.listAvailableModels = async function() {
            const apiKeyInput = document.getElementById('apiKey');
            const resultDiv = document.getElementById('result');
            const listBtn = document.getElementById('listBtn');
            
            let apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                resultDiv.innerHTML = '<span class="error">‚ùå Please enter your API key first.</span>';
                return;
            }

            listBtn.disabled = true;
            resultDiv.innerHTML = '<span class="loading">üîÑ Fetching available models from Google API...</span><br><br>';

            try {
                // Call Google's models.list API endpoint
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.models && data.models.length > 0) {
                    resultDiv.innerHTML += '<span class="success"><strong>‚úÖ Available Models:</strong></span><br><br>';
                    
                    // Filter and display models that support generateContent
                    const supportedModels = data.models.filter(model => 
                        model.supportedGenerationMethods && 
                        model.supportedGenerationMethods.includes('generateContent')
                    );

                    resultDiv.innerHTML += `<span class="info">Found ${supportedModels.length} models that support generateContent:</span><br><br>`;

                    supportedModels.forEach(model => {
                        const isVision = model.supportedGenerationMethods.includes('generateContent') && 
                                        (model.name.includes('vision') || 
                                         model.inputTokenLimit > 1000000); // Vision models typically have higher limits
                        const badge = isVision ? '<span style="background: #0f9d58; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">VISION</span>' : '';
                        
                        resultDiv.innerHTML += `
                            <div style="margin: 8px 0; padding: 8px; background: #f9f9f9; border-left: 3px solid #4285f4;">
                                <strong>${model.name}</strong> ${badge}<br>
                                <small style="color: #666;">
                                    Input: ${(model.inputTokenLimit / 1000000).toFixed(1)}M tokens | 
                                    Output: ${(model.outputTokenLimit / 1000000).toFixed(1)}M tokens
                                </small>
                            </div>
                        `;
                    });

                    // Extract model names for testing
                    const modelNames = supportedModels.map(m => m.name.split('/').pop());
                    window.availableModels = modelNames; // Store for testing
                    
                    resultDiv.innerHTML += '<br><hr><br>';
                    resultDiv.innerHTML += `<span class="info"><strong>Model names to use in code:</strong></span><br>`;
                    modelNames.forEach(name => {
                        resultDiv.innerHTML += `<code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${name}</code> `;
                    });
                    resultDiv.innerHTML += '<br><br><span class="success">‚úÖ Now click "Test API Key" to test these models!</span>';

                } else {
                    resultDiv.innerHTML += '<span class="error">‚ùå No models found in API response.</span><br>';
                    resultDiv.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }

            } catch (error) {
                resultDiv.innerHTML += `<span class="error">‚ùå Error fetching models: ${error.message}</span><br>`;
                console.error('Error:', error);
            } finally {
                listBtn.disabled = false;
            }
        };

        window.clearResults = function() {
            document.getElementById('result').innerHTML = '';
            window.workingApiKey = null;
            window.workingModel = null;
            document.getElementById('testFileBtn').disabled = true;
        };

        // Try to load API key from URL parameter (for convenience)
        const urlParams = new URLSearchParams(window.location.search);
        const apiKeyParam = urlParams.get('key');
        if (apiKeyParam) {
            document.getElementById('apiKey').value = apiKeyParam;
        }
    </script>
</body>
</html>

