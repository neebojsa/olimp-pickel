/**
 * Express server for generating PDFs using Playwright
 * 
 * To use this:
 * 1. Install dependencies: npm install express cors playwright @supabase/supabase-js dotenv
 * 2. Install Playwright browsers: npx playwright install chromium
 * 3. Run: npm run pdf-server
 * 4. The server will run on http://localhost:3001
 * 
 * Endpoints:
 * - GET /api/invoice/:id/pdf - Generate PDF for invoice by ID
 * - POST /generate-pdf - Generate PDF from HTML (legacy endpoint)
 * - GET /health - Health check
 */

import dotenv from 'dotenv';
import express from 'express';
import cors from 'cors';
import { chromium } from 'playwright';
import { createClient } from '@supabase/supabase-js';
// Note: invoiceHtmlTemplate.js is kept for legacy/debug purposes but is NOT used for PDF generation
// All PDFs are generated by navigating to the /invoices/:id/print route
import { fileURLToPath } from 'url';
import { dirname } from 'path';
import { resolve } from 'path';

// Load environment variables from .env file
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
dotenv.config({ path: resolve(__dirname, '..', '.env') });

const app = express();
const PORT = process.env.PORT || 3001;

app.use(cors());
app.use(express.json({ limit: '50mb' }));

// Supabase configuration (use service role for server-side access)
const SUPABASE_URL = process.env.SUPABASE_URL || 'https://nebgrdwjheeuactkcebw.supabase.co';
const SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || '';

// Debug: Log environment variables (remove in production)
console.log('Environment check:');
console.log('SUPABASE_URL:', SUPABASE_URL ? '✓ Set' : '✗ Missing');
console.log('SUPABASE_SERVICE_ROLE_KEY:', SUPABASE_SERVICE_ROLE_KEY ? '✓ Set (length: ' + SUPABASE_SERVICE_ROLE_KEY.length + ')' : '✗ Missing');

if (!SUPABASE_SERVICE_ROLE_KEY) {
  console.error('ERROR: SUPABASE_SERVICE_ROLE_KEY is required but not set.');
  console.error('Please add SUPABASE_SERVICE_ROLE_KEY to your .env file.');
  console.error('Get it from: Supabase Dashboard → Settings → API → Service Role Key');
  process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
});

// Cache browser instance
let browser = null;

const getBrowser = async () => {
  if (!browser) {
    browser = await chromium.launch({
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });
  }
  return browser;
};

/**
 * Generate PDF from HTML using Playwright
 */
const generatePDFFromHTML = async (html, filename = 'invoice.pdf') => {
  const browserInstance = await getBrowser();
  const page = await browserInstance.newPage();
  
  try {
    // Set content and wait for fonts/images to load
    await page.setContent(html, { 
      waitUntil: 'networkidle',
      timeout: 30000 
    });
    
    // Wait for fonts to be ready
    await page.evaluate(() => {
      return document.fonts.ready;
    });
    
    // Emulate print media to apply @media print styles
    await page.emulateMedia({ media: 'print' });
    
    // Generate PDF with print settings
    const pdfBuffer = await page.pdf({
      format: 'A4',
      printBackground: true,
      preferCSSPageSize: true,
      margin: {
        top: '0mm',
        right: '0mm',
        bottom: '0mm',
        left: '0mm'
      }
    });
    
    return pdfBuffer;
  } finally {
    await page.close();
  }
};

/**
 * Fetch invoice data from Supabase
 */
const fetchInvoiceData = async (invoiceId) => {
  // Fetch invoice with all related data
  const { data: invoice, error: invoiceError } = await supabase
    .from('invoices')
    .select(`
      *,
      customers!inner(id, name, country, address, city, phone, dap_address, fco_address),
      invoice_items!fk_invoice_items_invoice(*)
    `)
    .eq('id', invoiceId)
    .single();
  
  if (invoiceError || !invoice) {
    throw new Error(`Invoice not found: ${invoiceError?.message || 'Unknown error'}`);
  }
  
  // Fetch company info
  const { data: companyInfo, error: companyError } = await supabase
    .from('company_info')
    .select('*')
    .single();
  
  if (companyError) {
    console.warn('Warning: Could not fetch company info:', companyError.message);
  }
  
  // Fetch invoice settings
  const { data: invoiceSettings, error: settingsError } = await supabase
    .from('invoice_settings')
    .select('*')
    .single();
  
  if (settingsError) {
    console.warn('Warning: Could not fetch invoice settings:', settingsError.message);
  }
  
  // Fetch inventory items for weight/unit lookup
  const { data: inventoryItems, error: inventoryError } = await supabase
    .from('inventory')
    .select('*')
    .eq('category', 'Parts');
  
  if (inventoryError) {
    console.warn('Warning: Could not fetch inventory items:', inventoryError.message);
  }
  
  return {
    invoice,
    companyInfo: companyInfo || {},
    invoiceSettings: invoiceSettings || {
      primaryColor: '#000000',
      domesticFooter: ['', '', ''],
      foreignFooter: ['', '', ''],
      foreignNote: '',
      signatory: ''
    },
    inventoryItems: inventoryItems || []
  };
};

/**
 * Generate PDF by navigating to the print route
 */
const generatePDFFromURL = async (url, filename = 'invoice.pdf') => {
  const browserInstance = await getBrowser();
  const page = await browserInstance.newPage();
  
  try {
    // Set a longer timeout for page load
    page.setDefaultTimeout(60000);
    
    // Navigate to the print route
    console.log(`Navigating to: ${url}`);
    await page.goto(url, { 
      waitUntil: 'networkidle',
      timeout: 60000 
    });
    
    // Check for errors in console
    page.on('console', msg => {
      if (msg.type() === 'error') {
        console.error('Page console error:', msg.text());
      }
    });
    
    // Wait for the invoice print ready flag set by InvoicePrint.tsx
    // This ensures React has finished rendering and all data is loaded
    console.log('Waiting for invoice print ready flag...');
    try {
      await page.waitForFunction(
        () => window.__INVOICE_PRINT_READY__ === true,
        { timeout: 60000 }
      );
      console.log('Invoice print ready flag detected');
    } catch (error) {
      console.error('Timeout waiting for ready flag. Checking page state...');
      // Check what's on the page
      const pageContent = await page.content();
      const hasInvoiceContent = pageContent.includes('invoice-container') || pageContent.includes('print-invoice-page');
      const hasError = pageContent.includes('Invoice not found') || pageContent.includes('Loading invoice');
      console.log('Page has invoice content:', hasInvoiceContent);
      console.log('Page has error:', hasError);
      
      // If we have content but no flag, wait a bit more and proceed
      if (hasInvoiceContent && !hasError) {
        console.log('Content detected but flag not set, waiting additional 2 seconds...');
        await page.waitForTimeout(2000);
      } else {
        throw new Error('Invoice content not found on page. Check authentication and data loading.');
      }
    }
    
    // Wait for fonts to be ready
    await page.evaluate(() => {
      return document.fonts.ready;
    });
    
    // Additional wait to ensure all images are loaded
    await page.evaluate(() => {
      return Promise.all(
        Array.from(document.images).map(img => {
          if (img.complete) return Promise.resolve();
          return new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
            setTimeout(resolve, 3000); // Timeout after 3s
          });
        })
      );
    }).catch(() => {
      console.warn('Some images may not have loaded');
    });
    
    // Emulate print media to apply @media print styles
    // IMPORTANT: This must be called AFTER the page is ready but BEFORE pdf()
    await page.emulateMedia({ media: 'print' });
    
    // Small delay to ensure print styles are applied
    await page.waitForTimeout(500);
    
    // Generate PDF with print settings
    console.log('Generating PDF...');
    const pdfBuffer = await page.pdf({
      format: 'A4',
      printBackground: true,
      preferCSSPageSize: true,
      margin: {
        top: '0mm',
        right: '0mm',
        bottom: '0mm',
        left: '0mm'
      }
    });
    
    console.log(`PDF generated successfully, size: ${pdfBuffer.length} bytes`);
    return pdfBuffer;
  } catch (error) {
    console.error('Error in generatePDFFromURL:', error);
    throw error;
  } finally {
    await page.close();
  }
};

/**
 * GET /api/invoice/:id/pdf
 * Generate PDF for invoice by ID by navigating to the print route
 */
app.get('/api/invoice/:id/pdf', async (req, res) => {
  try {
    const { id } = req.params;
    
    if (!id) {
      return res.status(400).json({ error: 'Invoice ID is required' });
    }
    
    // Get the frontend app URL from environment
    // Note: Vite dev server runs on port 5173 by default, production might be different
    // Check your vite.config.ts or .env for the actual port
    const APP_BASE_URL = process.env.APP_BASE_URL || process.env.VITE_APP_URL || 'http://localhost:5173';
    
    // Navigate to the print route
    const printUrl = `${APP_BASE_URL}/invoices/${id}/print`;
    
    console.log(`Generating PDF for invoice ${id} from URL: ${printUrl}`);
    
    // Fetch invoice data to get invoice number for filename
    // This also validates the invoice exists before trying to render
    const { invoice } = await fetchInvoiceData(id);
    
    if (!invoice) {
      return res.status(404).json({ error: 'Invoice not found' });
    }
    
    console.log(`Invoice found: ${invoice.invoice_number}`);
    
    // Generate PDF by navigating to the print route
    const pdfBuffer = await generatePDFFromURL(printUrl, `invoice-${invoice.invoice_number}.pdf`);
    
    // Send PDF as response
    res.setHeader('Content-Type', 'application/pdf');
    res.setHeader('Content-Disposition', `attachment; filename="invoice-${invoice.invoice_number}.pdf"`);
    res.send(pdfBuffer);
    
  } catch (error) {
    console.error('Error generating invoice PDF:', error);
    res.status(500).json({ 
      error: 'Failed to generate PDF', 
      details: error.message 
    });
  }
});

/**
 * POST /generate-pdf
 * Legacy endpoint - generate PDF from HTML (for backward compatibility)
 */
app.post('/generate-pdf', async (req, res) => {
  try {
    const { html } = req.body;
    
    if (!html) {
      return res.status(400).json({ error: 'HTML content is required' });
    }
    
    const pdfBuffer = await generatePDFFromHTML(html);
    
    res.setHeader('Content-Type', 'application/pdf');
    res.setHeader('Content-Disposition', 'attachment; filename="invoice.pdf"');
    res.send(pdfBuffer);
    
  } catch (error) {
    console.error('Error generating PDF:', error);
    res.status(500).json({ error: 'Failed to generate PDF', details: error.message });
  }
});

/**
 * GET /health
 * Health check endpoint
 */
app.get('/health', (req, res) => {
  res.json({ 
    status: 'ok', 
    browser: browser ? 'connected' : 'not initialized',
    supabase: SUPABASE_URL ? 'configured' : 'not configured'
  });
});

// Graceful shutdown
process.on('SIGTERM', async () => {
  if (browser) {
    await browser.close();
  }
  process.exit(0);
});

process.on('SIGINT', async () => {
  if (browser) {
    await browser.close();
  }
  process.exit(0);
});

app.listen(PORT, () => {
  console.log(`PDF Generator server running on http://localhost:${PORT}`);
  console.log(`Using Playwright for PDF generation`);
  if (!SUPABASE_SERVICE_ROLE_KEY) {
    console.warn('WARNING: Set SUPABASE_SERVICE_ROLE_KEY environment variable for invoice PDF generation');
  }
});

export default app;

